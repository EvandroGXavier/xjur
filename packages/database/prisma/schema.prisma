// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 1. SAAS CORE MODULE
model Tenant {
  id          String   @id @default(uuid())
  name        String
  document    String   @unique // CNPJ/CPF do escritório
  planId      String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  plan        Plan?    @relation(fields: [planId], references: [id])
  users       User[]
  contacts    Contact[]
  processes   Process[]
  categories  DocumentCategory[]
  templates   DocumentTemplate[]
  communicationLogs CommunicationLog[]
  documentHistory   DocumentHistory[]
  // financialRecords  FinancialRecord[] // Deprecated/Removed
  financialSettings FinancialSettings?
  bankAccounts      BankAccount[]
  transactionCategories TransactionCategory[]
  transactions      Transaction[]
  recurringExpenses RecurringExpense[]

  relationTypes     RelationType[]
  contactRelations  ContactRelation[]
  assetTypes        AssetType[]
  contactAssets     ContactAsset[]
  
  @@map("tenants")
}

model Plan {
  id             String   @id @default(uuid())
  name           String
  maxUsers       Int
  maxStorage     Int      @default(500) // MB
  priceMonthly   Decimal
  features       Json
  tenants        Tenant[]
  
  @@map("plans")
}

model User {
  id        String   @id @default(uuid())
  tenantId  String
  email     String   @unique
  password  String
  name      String
  role      String   @default("LAWYER") // ADMIN, LAWYER, SECRETARY
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  
  @@map("users")
}

// 2. CONTACTS CRM (V2 - Consolidated)
model Contact {
  id                String    @id @default(uuid())
  tenantId          String
  
  // Base fields
  document          String?   // CPF or CNPJ (clean)
  name              String?   // Nome Completo or Razão Social
  fantasyName       String?   // Nome Fantasia (for PJ)
  personType        String    @default("PF") // PF or PJ
  category          String    @default("CLIENTE") // LEAD, CLIENTE, PARCEIRO, FORNECEDOR
  
  // Contact Info
  email             String?
  phone             String?
  whatsapp          String?
  
  // Specific Data (1:1 Relations)
  pfData            ContactPF?
  pjData            ContactPJ?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relacionamentos
  addresses          Address[]
  additionalContacts AdditionalContact[]
  processes          Process[]
  communications     CommunicationLog[]
  relationsFrom      ContactRelation[] @relation("RelationsFrom")
  relationsTo        ContactRelation[] @relation("RelationsTo")
  assets             ContactAsset[]
  
  debtorTransactions   Transaction[] @relation("DebtorTrx")
  creditorTransactions Transaction[] @relation("CreditorTrx")
  
  recurringDebtor      RecurringExpense[] @relation("RecurringDebtor")
  recurringCreditor    RecurringExpense[] @relation("RecurringCreditor")

  tenant             Tenant   @relation(fields: [tenantId], references: [id])

  @@index([document])
  @@index([personType])
  @@index([category])
  @@map("contacts")
}

model ContactPF {
  id              String    @id @default(uuid())
  contactId       String    @unique
  tenantId        String
  
  // Mapping to new V2 fields
  cpf             String?   @unique
  rg              String?
  birthDate       DateTime? @map("data_nascimento")
  civilStatus     String?   @map("estado_civil") 
  profession      String?   @map("profissao")
  nationality     String?   @default("Brasileira")
  
  contact         Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  tenant          Tenant    @relation(fields: [tenantId], references: [id])

  @@map("contato_pf")
}

model ContactPJ {
  id              String    @id @default(uuid())
  contactId       String    @unique
  tenantId        String
  
  // Mapping to new V2 fields
  cnpj            String?   @unique
  companyName     String?   @map("razao_social")
  stateReg        String?   @map("inscricao_estadual")
  municipalReg    String?   @map("inscricao_municipal")
  foundingDate    DateTime? @map("data_abertura")
  legalNature     String?   @map("natureza_juridica")
  
  contact         Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  tenant          Tenant    @relation(fields: [tenantId], references: [id])

  @@map("contato_pj")
}

model RelationType {
  id          String   @id @default(uuid())
  tenantId    String
  name        String   // Ex: Pai, Sócio
  reverseName String?  // Ex: Filho (opcional, se null usa name)
  isBilateral Boolean  @default(false)
  createdAt   DateTime @default(now())

  relations   ContactRelation[]
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  @@map("relation_types")
}

model ContactRelation {
  id             String   @id @default(uuid())
  tenantId       String
  fromContactId  String
  toContactId    String
  relationTypeId String
  
  fromContact    Contact      @relation("RelationsFrom", fields: [fromContactId], references: [id], onDelete: Cascade)
  toContact      Contact      @relation("RelationsTo", fields: [toContactId], references: [id], onDelete: Cascade)
  relationType   RelationType @relation(fields: [relationTypeId], references: [id])
  
  createdAt      DateTime @default(now())
  
  @@map("contact_relations")
}

model AssetType {
  id          String   @id @default(uuid())
  tenantId    String
  name        String   // Ex: Veículo, Imóvel, Marca
  description String?
  
  assets      ContactAsset[]
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  @@map("asset_types")
}

model ContactAsset {
  id          String   @id @default(uuid())
  tenantId    String
  contactId   String
  assetTypeId String
  
  name        String   // Ex: Ford Ka 2020
  value       Decimal? @db.Decimal(15,2)
  description String?
  acquisitionDate DateTime?
  
  contact     Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  assetType   AssetType @relation(fields: [assetTypeId], references: [id])
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  
  @@map("contact_assets")
}

model Address {
  id          String   @id @default(uuid())
  contactId   String
  street      String
  number      String
  complement  String?
  district    String
  city        String
  state       String
  zipCode     String
  type        String   @default("RESIDENCIAL")
  
  contact     Contact  @relation(fields: [contactId], references: [id])
  
  @@map("addresses")
}

model AdditionalContact {
  id          String   @id @default(uuid())
  contactId   String
  type        String   @default("EMAIL") // EMAIL, PHONE, WHATSAPP
  value       String
  label       String?  // Pessoal, Comercial
  
  contact     Contact  @relation(fields: [contactId], references: [id])
  
  @@map("additional_contacts")
}

// 3. PROCESS MANAGEMENT (JUDICIAL & CONTRACTS)
model Process {
  id          String    @id @default(uuid())
  tenantId    String
  
  // Fields compatible with EPROC/CNJ
  cnj         String?   @unique // Optional for non-judicial cases
  court       String?   // TJMG, TRT3, etc. Optional
  status      String    @default("ACTIVE") // ACTIVE, ARCHIVED, SUSPENDED
  
  // New Case Management Fields
  category    String    @default("JUDICIAL") // JUDICIAL, ADMINISTRATIVE, CONTRACT, CONSULTATION
  title       String?   // Friendly name for the case
  code        String?   // Internal reference code (e.g., CASE-2024-001)
  value       Decimal?  @default(0) @db.Decimal(15,2)
  
  // Dates
  distributionDate DateTime?
  lastUpdate       DateTime  @updatedAt
  
  tenant      Tenant              @relation(fields: [tenantId], references: [id])
  contacts    ProcessContact[]
  movements   ProcessMovement[]
  
  // Financial link
  transactions Transaction[]
  
  @@index([cnj])
  @@index([code])
  @@map("processes")
}

model ProcessContact {
  id          String   @id @default(uuid())
  processId   String
  contactId   String
  role        String   // AUTOR, RÉU, ADVOGADO
  
  process     Process  @relation(fields: [processId], references: [id])
  contact     Contact  @relation(fields: [contactId], references: [id])
  
  @@map("process_contacts")
}

model ProcessMovement {
  id          String   @id @default(uuid())
  processId   String
  date        DateTime
  description String
  type        String   // DESPACHO, SENTENÇA, ETC
  
  process     Process  @relation(fields: [processId], references: [id])
  
  @@map("process_movements")
}

// 4. DOCUMENT GENERATION (VISUAL LAW)
model DocumentTemplate {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  content     String   @db.Text // HTML/JSON do Tiptap
  category    String?
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  history     DocumentHistory[]
  
  @@map("document_templates")
}

model DocumentCategory {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  @@map("document_categories")
}

model DocumentHistory {
  id          String   @id @default(uuid())
  tenantId    String
  templateId  String?
  finalContent String  @db.Text
  generatedAt DateTime @default(now())
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  template    DocumentTemplate? @relation(fields: [templateId], references: [id])
  
  @@map("document_history")
}

// 5. OMNICHANNEL (WHATSAPP/EMAIL)
model CommunicationLog {
  id          String   @id @default(uuid())
  tenantId    String
  contactId   String?
  channel     String   // WHATSAPP, EMAIL
  direction   String   // INBOUND, OUTBOUND
  content     String   @db.Text
  status      String   // SENT, READ, FAILED
  externalId  String?  // MessageID do provedor
  timestamp   DateTime @default(now())
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  contact     Contact? @relation(fields: [contactId], references: [id])
  
  @@map("communication_logs")
}

// 6. FINANCIAL MODULE
model BankAccount {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  type        String   @default("CHECKING") // CHECKING, SAVINGS, INVESTMENT
  balance     Decimal  @default(0) @db.Decimal(15,2)
  bankName    String?
  agency      String?
  account     String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  transactions Transaction[]

  @@map("bank_accounts")
}

model TransactionCategory {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  type        String   // INCOME, EXPENSE
  
  transactions Transaction[]
  recurringExpenses RecurringExpense[]
  tenant       Tenant   @relation(fields: [tenantId], references: [id])
  
  @@map("transaction_categories")
}

model Transaction {
  id          String   @id @default(uuid())
  tenantId    String
  
  description String
  amount      Decimal  @db.Decimal(15,2)
  type        String   // INCOME, EXPENSE
  status      String   @default("PENDING") // PENDING, PAID, OVERDUE, CANCELLED
  
  dueDate     DateTime
  paymentDate DateTime?
  
  // Relacionamentos
  bankAccountId String?
  categoryId    String?
  processId     String?
  creditorId    String? // Quem recebe (Fornecedor ou Escritório)
  debtorId      String? // Quem paga (Cliente ou Escritório)

  // Advanced fields (V2)
  installmentId      String?  // UUID linking installments
  installmentNumber  Int?     // 1, 2, 3...
  totalInstallments  Int?     // Total (e.g. 10)
  
  originalAmount     Decimal? @db.Decimal(15,2) // Before interest/fines
  interest           Decimal? @default(0) @db.Decimal(15,2)
  fine               Decimal? @default(0) @db.Decimal(15,2)
  discount           Decimal? @default(0) @db.Decimal(15,2)
  
  recurringExpenseId String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  bankAccount BankAccount? @relation(fields: [bankAccountId], references: [id])
  category    TransactionCategory? @relation(fields: [categoryId], references: [id])
  process     Process?     @relation(fields: [processId], references: [id])
  tenant      Tenant       @relation(fields: [tenantId], references: [id])
  
  creditor    Contact?     @relation("CreditorTrx", fields: [creditorId], references: [id])
  debtor      Contact?     @relation("DebtorTrx", fields: [debtorId], references: [id])
  
  recurringExpense RecurringExpense? @relation(fields: [recurringExpenseId], references: [id])

  @@map("transactions")
}

model RecurringExpense {
  id          String   @id @default(uuid())
  tenantId    String
  
  description String
  amount      Decimal  @db.Decimal(15,2)
  frequency   String   // MONTHLY, WEEKLY, YEARLY
  dayOfMonth  Int      // 1-31
  
  isActive    Boolean  @default(true)
  lastGenerationDate DateTime?
  nextProcessDate    DateTime?
  
  categoryId  String?
  creditorId  String?
  debtorId    String?

  category        TransactionCategory? @relation(fields: [categoryId], references: [id])
  creditor        Contact?             @relation("RecurringCreditor", fields: [creditorId], references: [id])
  debtor          Contact?             @relation("RecurringDebtor", fields: [debtorId], references: [id])
  
  transactions    Transaction[]
  tenant          Tenant               @relation(fields: [tenantId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("recurring_expenses")
}

model FinancialSettings {
  id          String   @id @default(uuid())
  tenantId    String   @unique
  
  defaultBankAccount    String? // JSON or ID
  defaultCategories     String? // JSON
  fiscalYearStart       DateTime?
  currency              String  @default("BRL")
  defaultOfficeContactId String? // ID do contato que representa o escritório

  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  @@map("financial_settings")
}
