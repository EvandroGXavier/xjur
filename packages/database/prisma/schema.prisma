// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 1. SAAS CORE MODULE
model Tenant {
  id          String   @id @default(uuid())
  name        String
  document    String   @unique // CNPJ/CPF do escrit√≥rio
  planId      String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  plan        Plan?    @relation(fields: [planId], references: [id])
  users       User[]
  contacts    Contact[]
  processes   Process[]
  categories  DocumentCategory[]
  templates   DocumentTemplate[]
  communicationLogs CommunicationLog[]
  documentHistory   DocumentHistory[]
  financialRecords  FinancialRecord[]
  bankAccounts      BankAccount[]
  relationTypes     RelationType[]
  contactRelations  ContactRelation[]
  assetTypes        AssetType[]
  contactAssets     ContactAsset[]
  financialParties  FinancialParty[]
  transactionSplits TransactionSplit[]
  financialCategories FinancialCategory[]
  
  // Integra√ß√£o Microsoft 365 (OneDrive/SharePoint)
  msTenantId        String?
  msClientId        String?
  msClientSecret    String?
  msAccessToken     String?   @db.Text
  msRefreshToken    String?   @db.Text
  msFolderId        String?   // Pasta raiz do escrit√≥rio no OneDrive
  msStorageActive   Boolean   @default(false)
  
  // New Modules Relationships
  tags              Tag[]
  appointments      Appointment[]
  products          Product[]
  suppliers         Supplier[]
  inventoryMovements InventoryMovement[]
  tickets           Ticket[]
  waInstances       WaInstance[]
  connections       Connection[]
  partyRoles        PartyRole[]
  processParties    ProcessParty[]

  // Preferences
  contactRequireOneInfo Boolean @default(true) // Se false, celular/telefone/email ficam n√£o-obrigat√≥rios

  @@map("tenants")
}

model Plan {
  id          String   @id @default(uuid())
  name        String   // BASIC, PRO, FULL
  maxUsers    Int
  maxStorage  Int      // MB
  price       Decimal  @db.Decimal(10, 2)
  
  tenants     Tenant[]

  @@map("plans")
}

model User {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  email       String   @unique
  password    String
  role        String   // OWNER, ADMIN, MEMBER
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  @@map("users")
}

// 2.1 ENTIDADE √ÇNCORA: CONTACT
model Contact {
  id                String    @id @default(uuid())
  tenantId          String
  name              String
  personType        String    @default("PF") // PF ou PJ
  
  // Campos Gerais
  document          String?   // CPF/CNPJ (Mantido para busca r√°pida/compatibilidade)
  whatsapp          String?
  email             String?
  phone             String?
  notes             String?
  category          String?   // Cliente, Fornecedor, Parte Contr√°ria, Perito, Funcion√°rio
  password          String?   // Senha para acesso ao sistema
  profilePicUrl     String?   // URL da foto de perfil
  active            Boolean   @default(true)
  
  // Detalhes Espec√≠ficos (1:1)
  pfDetails         PersonDetailPF?
  pjDetails         PersonDetailPJ?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relacionamentos
  addresses          Address[]
  additionalContacts AdditionalContact[]
  processes          Process[]
  communications     CommunicationLog[]
  relationsFrom      ContactRelation[] @relation("RelationsFrom")
  relationsTo        ContactRelation[] @relation("RelationsTo")
  assets             ContactAsset[]
  bankAccounts       BankAccount[] @relation("BankAccounts")
  
  // New Modules Relationships
  tags               ContactTag[]
  appointmentParticipations AppointmentParticipant[]
  tickets            Ticket[]
  processParties     ProcessParty[]
  financialParties   FinancialParty[]
  
  tenant             Tenant   @relation(fields: [tenantId], references: [id])

  @@index([document]) // Index on document generic field
  @@index([personType])
  @@index([category])
  @@map("contacts")
}

model PersonDetailPF {
  id        String   @id @default(uuid())
  contactId String   @unique
  
  cpf            String?
  rg             String?
  rgIssuer       String?
  rgIssueDate    DateTime?
  birthDate      DateTime?
  
  nis            String?
  pis            String?
  ctps           String?
  motherName     String?
  fatherName     String?
  profession     String?
  nationality    String?
  naturality     String?
  gender         String?
  civilStatus    String?
  
  // CNH (New Fields)
  cnh            String?
  cnhIssuer      String?
  cnhIssueDate   DateTime?
  cnhCategory    String?
  cnhExpirationDate DateTime?
  fullName       String? // Nome completo legal (diferente do display name)
  
  contact   Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  
  @@map("person_details_pf")
}

model PersonDetailPJ {
  id                String   @id @default(uuid())
  contactId         String   @unique
  
  cnpj              String?
  companyName       String?   // Raz√£o Social
  stateRegistration String?   // Inscri√ß√£o Estadual
  
  // Dados Expandidos PJ (Receita Federal)
  openingDate       DateTime?
  size              String?      
  legalNature       String?      
  mainActivity      Json?        
  sideActivities    Json?        
  shareCapital      Decimal?     @db.Decimal(15, 2)
  status            String?      
  statusDate        DateTime?
  statusReason      String?
  specialStatus     String?
  specialStatusDate DateTime?
  pjQsa             Json?        
  
  contact           Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  
  @@map("person_details_pj")
}

model RelationType {
  id          String   @id @default(uuid())
  tenantId    String
  name        String   // Ex: Pai, S√≥cio
  reverseName String?  // Ex: Filho (opcional, se null usa name)
  isBilateral Boolean  @default(false)
  createdAt   DateTime @default(now())

  relations   ContactRelation[]
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  @@map("relation_types")
}

model ContactRelation {
  id             String   @id @default(uuid())
  tenantId       String
  fromContactId  String
  toContactId    String
  relationTypeId String
  
  fromContact    Contact      @relation("RelationsFrom", fields: [fromContactId], references: [id], onDelete: Cascade)
  toContact      Contact      @relation("RelationsTo", fields: [toContactId], references: [id], onDelete: Cascade)
  relationType   RelationType @relation(fields: [relationTypeId], references: [id])
  
  tenant         Tenant   @relation(fields: [tenantId], references: [id])

  @@unique([fromContactId, toContactId, relationTypeId]) // Evitar duplicatas exatas
  @@map("contact_relations")
}

model AssetType {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  createdAt   DateTime @default(now())

  assets      ContactAsset[]
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  @@map("asset_types")
}

model ContactAsset {
  id              String   @id @default(uuid())
  tenantId        String
  contactId       String
  assetTypeId     String
  description     String
  acquisitionDate DateTime?
  value           Decimal? @db.Decimal(10, 2)
  writeOffDate    DateTime?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  contact         Contact    @relation(fields: [contactId], references: [id], onDelete: Cascade)
  assetType       AssetType  @relation(fields: [assetTypeId], references: [id])
  tenant          Tenant     @relation(fields: [tenantId], references: [id])

  @@map("contact_assets")
}

model Address {
  id         String  @id @default(uuid())
  contactId  String
  type       String  @default("Principal") // Principal, Comercial, Residencial, etc.
  zipCode    String
  street     String
  number     String
  complement String?
  district   String? // Bairro
  city       String
  state      String
  contact    Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@map("addresses")
}

model AdditionalContact {
  id        String  @id @default(uuid())
  contactId String
  type      String  // EMAIL, PHONE, ETC
  value     String
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@map("additional_contacts")
}

// 2.2 M√ìDULOS JUR√çDICOS E FINANCEIROS
model Process {
  id             String   @id @default(uuid())
  tenantId       String
  contactId      String?  // Pode ser nulo inicialmente se criado via automa√ß√£o
  cnj            String?  @unique // Opcional para Casos/Consultivo
  
  // Identifica√ß√£o Interna
  category       String   @default("JUDICIAL") // JUDICIAL | EXTRAJUDICIAL
  title          String?  // T√≠tulo do Caso (ex: An√°lise Contratual)
  code           String?  // C√≥digo Interno (ex: CASO-25-001)
  folder         String?  // Pasta na Nuvem (Z:\, Google Drive)
  description    String?  @db.Text // Descri√ß√£o Rica (HTML/Markdown)
  
  // Microsoft 365 Integration
  msDriveId      String?  // ID da pasta do processo no OneDrive
  msFolderUrl    String?  // Link do OneDrive para acesso r√°pido

  // Detalhes Jur√≠dicos
  npu            String?     // Numera√ß√£o √önica (Normalizada)
  court          String?     // Tribunal (TJMG, TRF1, etc) - Opcional para Consultivo
  courtSystem    String?     // Sistema (PJe, Eproc, Projudi)
  vars           String?     // Vara / √ìrg√£o Julgador
  district       String?     // Comarca
  status         String      // OPORTUNIDADE, ATIVO, SUSPENSO, ARQUIVADO
  
  // Classifica√ß√£o
  area           String?     // C√≠vel, Trabalhista, Criminal
  subject        String?     // Assunto Principal
  class          String?     // Classe Processual
  distributionDate DateTime? // Data de Distribui√ß√£o
  judge          String?     // Magistrado
  value          Decimal?    @db.Decimal(15, 2)
  
  // Partes (Snapshot JSON para importa√ß√£o r√°pida)
  parties        Json?       // [{ name: "Jo√£o", type: "AUTOR", cpf: "..." }]
  
  // Automa√ß√£o
  lastCrawledAt  DateTime?   // √öltima atualiza√ß√£o via rob√¥
  autoUpdate     Boolean     @default(true)
  metadata       Json?       // Dados crus do crawler

  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  
  tenant         Tenant      @relation(fields: [tenantId], references: [id])

  contact        Contact?  @relation(fields: [contactId], references: [id])
  timeline       ProcessTimeline[]
  financials     FinancialRecord[]
  appointments   Appointment[]
  processParties ProcessParty[]
  tags           ProcessTag[]

  @@unique([tenantId, code])
  @@map("processes")
}

// 2.3 PARTES PROCESSUAIS (V√≠nculo Processo ‚Üî Contato)
model PartyRole {
  id          String   @id @default(uuid())
  tenantId    String
  name        String   // Ex: AUTOR, R√âU, TESTEMUNHA, PERITO
  category    String?  // POLO_ATIVO, POLO_PASSIVO, OUTROS
  isDefault   Boolean  @default(false) // Roles pr√©-cadastrados (seed)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())

  processParties ProcessParty[]
  tenant         Tenant   @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, name])
  @@map("party_roles")
}

model ProcessParty {
  id          String   @id @default(uuid())
  tenantId    String
  processId   String
  contactId   String
  roleId      String
  isClient    Boolean  @default(false)  // √â nosso cliente neste processo?
  isOpposing  Boolean  @default(false)  // √â parte contr√°ria?
  notes       String?  // Observa√ß√µes sobre a parte
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  process     Process   @relation(fields: [processId], references: [id], onDelete: Cascade)
  contact     Contact   @relation(fields: [contactId], references: [id])
  role        PartyRole @relation(fields: [roleId], references: [id])
  tenant      Tenant    @relation(fields: [tenantId], references: [id])

  @@unique([processId, contactId, roleId]) // Evita duplicata exata
  @@map("process_parties")
}

model ProcessTimeline {
  id          String   @id @default(uuid())
  processId   String
  title       String
  description String?
  date        DateTime
  type        String   // MOVEMENT, MESSAGE, FILE
  source      String?  // CRAWLER, MANUAL, USER_IMPORT
  metadata    Json?    // Store file paths or message IDs here
  createdAt   DateTime @default(now())

  // New Fields for DR.X
  displayId   String?  // Evento/ID original do tribunal
  internalSequence Int? // Sequ√™ncia 1, 2, 3 do DR.X
  origin      String?  // TRIBUNAL_PJE, TRIBUNAL_EPROC, INTERNO, IA
  internalDate DateTime? // Data alvo para solu√ß√£o do escrit√≥rio
  fatalDate   DateTime? // Prazo fatal do sistema judicial
  responsibleAdvogado String? // Nome ou ID do advogado
  aiSummary   String?  // Resumo simplificado para o cliente
  clientMessage String? // Texto formatado para envio via WhatsApp

  // --- MOTOR DE WORKFLOW ---
  category          String?  @default("REGISTRO") // REGISTRO, ACAO, AGENDA
  status            String?  @default("PENDENTE") // PENDENTE, EM_TRATAMENTO, CONCLUIDO
  priority          String?  @default("MEDIA")    // BAIXA, MEDIA, ALTA, URGENTE
  requesterName     String?  // Quem solicitou o andamento
  responsibleName   String?  // Quem deve tratar a a√ß√£o
  templateCode      String?  // Identificador do Template que gerou este andamento
  parentTimelineId  String?  // FK para o andamento "Pai"
  
  parentTimeline    ProcessTimeline?  @relation("WorkflowSequence", fields: [parentTimelineId], references: [id])
  childTimelines    ProcessTimeline[] @relation("WorkflowSequence")

  process     Process  @relation(fields: [processId], references: [id], onDelete: Cascade)

  @@map("process_timelines")
}

model FinancialRecord {
  id            String    @id @default(uuid())
  tenantId      String
  processId     String?
  bankAccountId String?
  categoryId    String?   // FK para FinancialCategory
  description   String
  amount        Decimal   @db.Decimal(15, 2)
  dueDate       DateTime
  paymentDate   DateTime?
  status        String    // PENDING, PAID, CANCELLED, OVERDUE, PARTIAL
  type          String    // INCOME (Receita), EXPENSE (Despesa)
  category      String?   // Legado: texto livre (Honor√°rios, Custas, etc)
  paymentMethod String?   // PIX, BOLETO, TED, DINHEIRO, CARTAO
  notes         String?   @db.Text

  // === ENCARGOS & DESCONTOS ===
  fine               Decimal?  @db.Decimal(15, 2) // Multa
  interest           Decimal?  @db.Decimal(15, 2) // Juros
  monetaryCorrection Decimal?  @db.Decimal(15, 2) // Corre√ß√£o monet√°ria
  discount           Decimal?  @db.Decimal(15, 2) // Desconto
  discountType       String?   // VALUE (valor fixo) ou PERCENTAGE (percentual)
  amountFinal        Decimal?  @db.Decimal(15, 2) // Valor final calculado (amount + encargos - descontos)
  amountPaid         Decimal?  @db.Decimal(15, 2) // Valor efetivamente pago

  // === PARCELAMENTO ===
  parentId           String?   // FK auto-referencial: transa√ß√£o-m√£e
  installmentNumber  Int?      // N√∫mero da parcela (1, 2, 3...)
  totalInstallments  Int?      // Total de parcelas
  periodicity        String?   // MONTHLY, BIWEEKLY, WEEKLY, CUSTOM
  isResidual         Boolean   @default(false) // Parcela residual de pagamento parcial?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Rela√ß√µes
  process            Process?            @relation(fields: [processId], references: [id])
  bankAccount        BankAccount?        @relation(fields: [bankAccountId], references: [id])
  tenant             Tenant              @relation(fields: [tenantId], references: [id])
  financialCategory  FinancialCategory?  @relation(fields: [categoryId], references: [id])
  parties            FinancialParty[]
  splits             TransactionSplit[]

  // Auto-relacionamento (Parcelas / Residuais)
  parent             FinancialRecord?    @relation("Installments", fields: [parentId], references: [id])
  children           FinancialRecord[]   @relation("Installments")

  @@index([parentId])
  @@index([tenantId, status])
  @@index([tenantId, type])
  @@index([tenantId, dueDate])
  @@map("financial_records")
}


model BankAccount {
  id              String   @id @default(uuid())
  tenantId        String
  title           String   // Nome/T√≠tulo da conta
  bankName        String?
  accountType     String   // CHECKING (Corrente), SAVINGS (Poupan√ßa)
  accountNumber   String?
  agency          String?
  balance         Decimal  @default(0) @db.Decimal(10, 2)
  contactId       String?  // ID do Titular (opcional)
  isActive        Boolean  @default(true)
  notes           String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant           Tenant   @relation(fields: [tenantId], references: [id])
  contact          Contact? @relation("BankAccounts", fields: [contactId], references: [id])
  financialRecords FinancialRecord[]

  @@index([contactId])
  @@map("bank_accounts")
}

model FinancialParty {
  id                String          @id @default(uuid())
  tenantId          String
  financialRecordId String
  contactId         String
  role              String          // CREDITOR, DEBTOR
  amount            Decimal?        @db.Decimal(10, 2)
  notes             String?

  financialRecord   FinancialRecord @relation(fields: [financialRecordId], references: [id], onDelete: Cascade)
  contact           Contact         @relation(fields: [contactId], references: [id])
  tenant            Tenant          @relation(fields: [tenantId], references: [id])

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@unique([financialRecordId, contactId, role])
  @@map("financial_parties")
}

// === RATEIO DE TRANSA√á√ÉO ===
model TransactionSplit {
  id                String   @id @default(uuid())
  tenantId          String
  financialRecordId String
  contactId         String
  role              String   // CREDITOR ou DEBTOR
  amount            Decimal  @db.Decimal(15, 2) // Valor absoluto do rateio
  percentage        Decimal? @db.Decimal(5, 2)  // % do total (ex: 33.33)
  description       String?  // Descri√ß√£o opcional do rateio
  isPaid            Boolean  @default(false)
  paidAt            DateTime?
  notes             String?

  financialRecord   FinancialRecord @relation(fields: [financialRecordId], references: [id], onDelete: Cascade)
  tenant            Tenant          @relation(fields: [tenantId], references: [id])

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([financialRecordId])
  @@map("transaction_splits")
}

// === CATEGORIAS FINANCEIRAS DIN√ÇMICAS ===
model FinancialCategory {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  type        String?  // INCOME, EXPENSE, BOTH
  color       String?  // Hex color
  icon        String?  // √çcone (opcional)
  parentId    String?  // Subcategorias
  active      Boolean  @default(true)

  parent      FinancialCategory?  @relation("CategoryTree", fields: [parentId], references: [id])
  children    FinancialCategory[] @relation("CategoryTree")
  tenant      Tenant              @relation(fields: [tenantId], references: [id])
  records     FinancialRecord[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tenantId, name])
  @@map("financial_categories")
}


// 3. A "INVEN√á√ÉO DR.X": TRIAGEM E COMUNICA√á√ÉO
model CommunicationLog {
  id          String   @id @default(uuid())
  tenantId    String
  contactId   String?
  direction   String   // INBOUND, OUTBOUND
  channel     String   // WHATSAPP
  content     String
  mediaUrl    String?  // Caminho local do arquivo
  mediaType   String?  // AUDIO, IMAGE, PDF
  status      String   // RECEIVED, TRIAGED, ARCHIVED
  processedBy String?  // AI or AGENT
  createdAt   DateTime @default(now())

  contact     Contact? @relation(fields: [contactId], references: [id])
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  @@map("communication_logs")
}

// 4. M√ìDULO DE MODELOS DE DOCUMENTOS (DR.X MODELS)

model DocumentCategory {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  parentId    String?
  
  parent      DocumentCategory? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    DocumentCategory[] @relation("CategoryHierarchy")
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  templates   DocumentTemplate[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("document_categories")
}

model DocumentTemplate {
  id          String   @id @default(uuid())
  tenantId    String
  title       String
  content     String   @db.Text
  categoryId  String?
  
  category    DocumentCategory? @relation(fields: [categoryId], references: [id])
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  history     DocumentHistory[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("document_templates")
}

model DocumentHistory {
  id          String   @id @default(uuid())
  tenantId    String
  templateId  String?
  title       String
  content     String   @db.Text
  snapshot    Json?    // Stores the variables values at time of creation
  status      String   // DRAFT, FINALIZED
  
  // Microsoft 365 Integration
  msFileId    String?  // ID do docx no OneDrive
  msFileUrl   String?  // Link de edi√ß√£o no Word Online
  
  template    DocumentTemplate? @relation(fields: [templateId], references: [id])
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("document_history")
}

model DocumentSettings {
  id          String   @id @default(uuid())
  key         String   @unique // HEADER, FOOTER, FONT_FAMILY
  value       String?
  
  updatedAt   DateTime @updatedAt

  @@map("document_settings")
}
// 5. M√ìDULO DE ETIQUETAS (TAGS TRANSVERSAIS)
model Tag {
  id        String   @id @default(uuid())
  tenantId  String
  name      String
  color     String   // Hex code
  textColor String?  // Hex code
  scope     Json?    // ["CONTACT", "PROCESS", "FINANCE", "TASK"]
  usage     Int      @default(0)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  contacts  ContactTag[]
  processes ProcessTag[]

  @@map("tags")
}

model ContactTag {
  id        String   @id @default(uuid())
  tagId     String
  contactId String
  
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  contact   Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([tagId, contactId])
  @@map("tags_on_contacts")
}

model ProcessTag {
  id        String   @id @default(uuid())
  tagId     String
  processId String
  
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  process   Process  @relation(fields: [processId], references: [id], onDelete: Cascade)

  @@unique([tagId, processId])
  @@map("tags_on_processes")
}

// 6. M√ìDULO AGENDA (COMPROMISSOS)
model Appointment {
  id          String   @id @default(uuid())
  tenantId    String
  title       String
  description String?
  type        String   // AUDIENCIA, PRAZO, REUNIAO, INTIMACAO
  startAt     DateTime
  endAt       DateTime
  status      String   // SCHEDULED, CONFIRMED, IN_PROGRESS, DONE, CANCELED, RESCHEDULED
  location    String?  // F√≠sico ou Link (Zoom/Meet)
  
  // V√≠nculos
  processId   String?
  process     Process? @relation(fields: [processId], references: [id])
  
  recurrence  Json?    // Regra de recorr√™ncia (RRule)
  
  participants AppointmentParticipant[]
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("appointments")
}

model AppointmentParticipant {
  id            String   @id @default(uuid())
  appointmentId String
  contactId     String?  // Pode ser um contato da base
  name          String?  // Ou apenas um nome avulso
  role          String   // RESPONSABLE, CLIENT, WITNESS, EXPERT
  confirmed     Boolean  @default(false)
  
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  contact       Contact?    @relation(fields: [contactId], references: [id])

  @@map("appointment_participants")
}

// 7. M√ìDULO ESTOQUE (PRODUTOS & MOVIMENTA√á√ïES)
model Product {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  barcode     String?
  minStock    Int      @default(0)
  currentStock Int     @default(0)
  costPrice   Decimal? @db.Decimal(10, 2)
  sellPrice   Decimal? @db.Decimal(10, 2)
  
  supplierId  String?
  supplier    Supplier? @relation(fields: [supplierId], references: [id])
  
  movements   InventoryMovement[]
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("products")
}

model Supplier {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  document    String?  // CNPJ
  email       String?
  phone       String?
  
  products    Product[]
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  createdAt   DateTime @default(now())

  @@map("suppliers")
}

model InventoryMovement {
  id          String   @id @default(uuid())
  tenantId    String
  productId   String
  type        String   // IN (Entrada), OUT (Sa√≠da), ADJUST (Ajuste)
  quantity    Int
  unitPrice   Decimal? @db.Decimal(10, 2)
  totalPrice  Decimal? @db.Decimal(10, 2)
  reason      String?
  
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  createdAt   DateTime @default(now())

  @@map("inventory_movements")
}

// 8. M√ìDULO ATENDIMENTO V2 (OMNICHANNEL TICKETS)
model Ticket {
  id          String   @id @default(uuid())
  tenantId    String
  code        Int      @default(autoincrement()) // Protocolo num√©rico amig√°vel
  title       String
  status      String   // OPEN, IN_PROGRESS, WAITING, RESOLVED, CLOSED
  priority    String   // LOW, MEDIUM, HIGH, URGENT
  channel     String   // WHATSAPP, EMAIL, PHONE, WEBCHAT
  
  contactId   String?
  contact     Contact? @relation(fields: [contactId], references: [id])
  
  assigneeId  String?  // Usu√°rio respons√°vel (User ID)
  queue       String?  // Departamento (FINANCEIRO, JURIDICO)
  
  isPinned    Boolean  @default(false)
  waitingReply Boolean @default(false)
  lastMessageAt DateTime? @default(now())
  
  messages    TicketMessage[]
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("tickets")
}

model TicketMessage {
  id          String   @id @default(uuid())
  ticketId    String
  externalId  String?  @unique
  status      String   @default("SENT") // PENDING, SENT, DELIVERED, READ, PLAYED, FAILED, SCHEDULED
  senderType  String   // USER (Agente), CONTACT (Cliente), SYSTEM (Bot)
  senderId    String?  // ID do User ou Contact
  content     String   @db.Text
  contentType String   // TEXT, IMAGE, AUDIO, FILE
  mediaUrl    String?
  quotedId    String?
  scheduledAt DateTime? // Time when the message should be sent
  
  reactions   Json?     // [{ emoji: "üëç", userId: "..." }]
  metadata    Json?     // Waveforms, thumbnails, etc.

  readAt      DateTime?
  
  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  @@map("ticket_messages")
}

model WaInstance {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  status      String   // DISCONNECTED, PAIRING, CONNECTED
  qrCode      String?  @db.Text
  serverUrl   String?
  apiKey      String?
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  updatedAt   DateTime @updatedAt

  @@map("wa_instances")
}

model Connection {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  type        String   // WHATSAPP, INSTAGRAM, EMAIL
  status      String   // CONNECTED, DISCONNECTED, PAIRING, ERROR
  
  config      Json?    // Credentials, tokens, settings
  qrCode      String?  @db.Text
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("connections")
}
