// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 1. SAAS CORE MODULE
model Tenant {
  id          String   @id @default(uuid())
  name        String
  document    String   @unique // CNPJ/CPF do escritório
  planId      String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  plan        Plan?    @relation(fields: [planId], references: [id])
  users       User[]
  contacts    Contact[]
  processes   Process[]
  categories  DocumentCategory[]
  templates   DocumentTemplate[]
  communicationLogs CommunicationLog[]
  documentHistory   DocumentHistory[]
  financialRecords  FinancialRecord[]
  bankAccounts      BankAccount[]
  relationTypes     RelationType[]
  contactRelations  ContactRelation[]
  assetTypes        AssetType[]
  contactAssets     ContactAsset[]
  
  // New Modules Relationships
  tags              Tag[]
  appointments      Appointment[]
  products          Product[]
  suppliers         Supplier[]
  inventoryMovements InventoryMovement[]
  tickets           Ticket[]
  waInstances       WaInstance[]
  partyRoles        PartyRole[]
  processParties    ProcessParty[]

  @@map("tenants")
}

model Plan {
  id          String   @id @default(uuid())
  name        String   // BASIC, PRO, FULL
  maxUsers    Int
  maxStorage  Int      // MB
  price       Decimal  @db.Decimal(10, 2)
  
  tenants     Tenant[]

  @@map("plans")
}

model User {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  email       String   @unique
  password    String
  role        String   // OWNER, ADMIN, MEMBER
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  @@map("users")
}

// 2.1 ENTIDADE ÂNCORA: CONTACT
model Contact {
  id                String    @id @default(uuid())
  tenantId          String
  name              String
  personType        String    @default("PF") // PF ou PJ
  
  // Campos Gerais
  document          String?   // CPF/CNPJ (Mantido para busca rápida/compatibilidade)
  whatsapp          String?
  email             String?
  phone             String?
  notes             String?
  category          String?   // Cliente, Fornecedor, Parte Contrária, Perito, Funcionário
  password          String?   // Senha para acesso ao sistema
  active            Boolean   @default(true)
  
  // Detalhes Específicos (1:1)
  pfDetails         PersonDetailPF?
  pjDetails         PersonDetailPJ?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relacionamentos
  addresses          Address[]
  additionalContacts AdditionalContact[]
  processes          Process[]
  communications     CommunicationLog[]
  relationsFrom      ContactRelation[] @relation("RelationsFrom")
  relationsTo        ContactRelation[] @relation("RelationsTo")
  assets             ContactAsset[]
  bankAccounts       BankAccount[] @relation("BankAccounts")
  
  // New Modules Relationships
  tags               ContactTag[]
  appointmentParticipations AppointmentParticipant[]
  tickets            Ticket[]
  processParties     ProcessParty[]
  
  tenant             Tenant   @relation(fields: [tenantId], references: [id])

  @@index([document]) // Index on document generic field
  @@index([personType])
  @@index([category])
  @@map("contacts")
}

model PersonDetailPF {
  id        String   @id @default(uuid())
  contactId String   @unique
  
  cpf            String?
  rg             String?
  rgIssuer       String?
  rgIssueDate    DateTime?
  birthDate      DateTime?
  
  nis            String?
  pis            String?
  ctps           String?
  motherName     String?
  fatherName     String?
  profession     String?
  nationality    String?
  naturality     String?
  gender         String?
  civilStatus    String?
  
  // CNH (New Fields)
  cnh            String?
  cnhIssuer      String?
  cnhIssueDate   DateTime?
  cnhCategory    String?
  cnhExpirationDate DateTime?
  fullName       String? // Nome completo legal (diferente do display name)
  
  contact   Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  
  @@map("person_details_pf")
}

model PersonDetailPJ {
  id                String   @id @default(uuid())
  contactId         String   @unique
  
  cnpj              String?
  companyName       String?   // Razão Social
  stateRegistration String?   // Inscrição Estadual
  
  // Dados Expandidos PJ (Receita Federal)
  openingDate       DateTime?
  size              String?      
  legalNature       String?      
  mainActivity      Json?        
  sideActivities    Json?        
  shareCapital      Decimal?     @db.Decimal(15, 2)
  status            String?      
  statusDate        DateTime?
  statusReason      String?
  specialStatus     String?
  specialStatusDate DateTime?
  pjQsa             Json?        
  
  contact           Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  
  @@map("person_details_pj")
}

model RelationType {
  id          String   @id @default(uuid())
  tenantId    String
  name        String   // Ex: Pai, Sócio
  reverseName String?  // Ex: Filho (opcional, se null usa name)
  isBilateral Boolean  @default(false)
  createdAt   DateTime @default(now())

  relations   ContactRelation[]
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  @@map("relation_types")
}

model ContactRelation {
  id             String   @id @default(uuid())
  tenantId       String
  fromContactId  String
  toContactId    String
  relationTypeId String
  
  fromContact    Contact      @relation("RelationsFrom", fields: [fromContactId], references: [id], onDelete: Cascade)
  toContact      Contact      @relation("RelationsTo", fields: [toContactId], references: [id], onDelete: Cascade)
  relationType   RelationType @relation(fields: [relationTypeId], references: [id])
  
  tenant         Tenant   @relation(fields: [tenantId], references: [id])

  @@unique([fromContactId, toContactId, relationTypeId]) // Evitar duplicatas exatas
  @@map("contact_relations")
}

model AssetType {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  createdAt   DateTime @default(now())

  assets      ContactAsset[]
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  @@map("asset_types")
}

model ContactAsset {
  id              String   @id @default(uuid())
  tenantId        String
  contactId       String
  assetTypeId     String
  description     String
  acquisitionDate DateTime?
  value           Decimal? @db.Decimal(10, 2)
  writeOffDate    DateTime?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  contact         Contact    @relation(fields: [contactId], references: [id], onDelete: Cascade)
  assetType       AssetType  @relation(fields: [assetTypeId], references: [id])
  tenant          Tenant     @relation(fields: [tenantId], references: [id])

  @@map("contact_assets")
}

model Address {
  id        String  @id @default(uuid())
  contactId String
  street    String
  number    String
  city      String
  state     String
  zipCode   String
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@map("addresses")
}

model AdditionalContact {
  id        String  @id @default(uuid())
  contactId String
  type      String  // EMAIL, PHONE, ETC
  value     String
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@map("additional_contacts")
}

// 2.2 MÓDULOS JURÍDICOS E FINANCEIROS
model Process {
  id             String   @id @default(uuid())
  tenantId       String
  contactId      String?  // Pode ser nulo inicialmente se criado via automação
  cnj            String?  @unique // Opcional para Casos/Consultivo
  
  // Identificação Interna
  category       String   @default("JUDICIAL") // JUDICIAL | EXTRAJUDICIAL
  title          String?  // Título do Caso (ex: Análise Contratual)
  code           String?  @unique // Código Interno (ex: CASO-25-001)
  folder         String?  // Pasta na Nuvem (Z:\, Google Drive)
  description    String?  @db.Text // Descrição Rica (HTML/Markdown)

  // Detalhes Jurídicos
  npu            String?     // Numeração Única (Normalizada)
  court          String?     // Tribunal (TJMG, TRF1, etc) - Opcional para Consultivo
  courtSystem    String?     // Sistema (PJe, Eproc, Projudi)
  vars           String?     // Vara / Órgão Julgador
  district       String?     // Comarca
  status         String      // OPORTUNIDADE, ATIVO, SUSPENSO, ARQUIVADO
  
  // Classificação
  area           String?     // Cível, Trabalhista, Criminal
  subject        String?     // Assunto Principal
  class          String?     // Classe Processual
  distributionDate DateTime? // Data de Distribuição
  judge          String?     // Magistrado
  value          Decimal?    @db.Decimal(15, 2)
  
  // Partes (Snapshot JSON para importação rápida)
  parties        Json?       // [{ name: "João", type: "AUTOR", cpf: "..." }]
  
  // Automação
  lastCrawledAt  DateTime?   // Última atualização via robô
  autoUpdate     Boolean     @default(true)
  metadata       Json?       // Dados crus do crawler

  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  
  tenant         Tenant      @relation(fields: [tenantId], references: [id])

  contact        Contact?  @relation(fields: [contactId], references: [id])
  timeline       ProcessTimeline[]
  financials     FinancialRecord[]
  appointments   Appointment[]
  processParties ProcessParty[]

  @@map("processes")
}

// 2.3 PARTES PROCESSUAIS (Vínculo Processo ↔ Contato)
model PartyRole {
  id          String   @id @default(uuid())
  tenantId    String
  name        String   // Ex: AUTOR, RÉU, TESTEMUNHA, PERITO
  category    String?  // POLO_ATIVO, POLO_PASSIVO, OUTROS
  isDefault   Boolean  @default(false) // Roles pré-cadastrados (seed)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())

  processParties ProcessParty[]
  tenant         Tenant   @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, name])
  @@map("party_roles")
}

model ProcessParty {
  id          String   @id @default(uuid())
  tenantId    String
  processId   String
  contactId   String
  roleId      String
  isClient    Boolean  @default(false)  // É nosso cliente neste processo?
  isOpposing  Boolean  @default(false)  // É parte contrária?
  notes       String?  // Observações sobre a parte
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  process     Process   @relation(fields: [processId], references: [id], onDelete: Cascade)
  contact     Contact   @relation(fields: [contactId], references: [id])
  role        PartyRole @relation(fields: [roleId], references: [id])
  tenant      Tenant    @relation(fields: [tenantId], references: [id])

  @@unique([processId, contactId, roleId]) // Evita duplicata exata
  @@map("process_parties")
}

model ProcessTimeline {
  id          String   @id @default(uuid())
  processId   String
  title       String
  description String?
  date        DateTime
  type        String   // MOVEMENT, MESSAGE, FILE
  source      String?  // CRAWLER, MANUAL, USER_IMPORT
  metadata    Json?    // Store file paths or message IDs here
  createdAt   DateTime @default(now())

  // New Fields for DR.X
  displayId   String?  // Evento/ID original do tribunal
  internalSequence Int? // Sequência 1, 2, 3 do DR.X
  origin      String?  // TRIBUNAL_PJE, TRIBUNAL_EPROC, INTERNO, IA
  internalDate DateTime? // Data alvo para solução do escritório
  fatalDate   DateTime? // Prazo fatal do sistema judicial
  responsibleAdvogado String? // Nome ou ID do advogado
  aiSummary   String?  // Resumo simplificado para o cliente
  clientMessage String? // Texto formatado para envio via WhatsApp

  process     Process  @relation(fields: [processId], references: [id], onDelete: Cascade)

  @@map("process_timelines")
}

model FinancialRecord {
  id            String    @id @default(uuid())
  tenantId      String
  processId     String?
  bankAccountId String?
  description   String
  amount        Decimal   @db.Decimal(10, 2)
  dueDate       DateTime
  paymentDate   DateTime?
  status        String    // PENDING, PAID, CANCELLED, OVERDUE
  type          String    // INCOME (Receita), EXPENSE (Despesa)
  category      String?   // Honorários, Custas, Aluguel, etc
  paymentMethod String?   // PIX, BOLETO, TED, DINHEIRO, CARTAO
  notes         String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  process       Process?      @relation(fields: [processId], references: [id])
  bankAccount   BankAccount?  @relation(fields: [bankAccountId], references: [id])
  tenant        Tenant        @relation(fields: [tenantId], references: [id])

  @@map("financial_records")
}


model BankAccount {
  id              String   @id @default(uuid())
  tenantId        String
  title           String   // Nome/Título da conta
  bankName        String?
  accountType     String   // CHECKING (Corrente), SAVINGS (Poupança)
  accountNumber   String?
  agency          String?
  balance         Decimal  @default(0) @db.Decimal(10, 2)
  contactId       String?  // ID do Titular (opcional)
  isActive        Boolean  @default(true)
  notes           String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant           Tenant   @relation(fields: [tenantId], references: [id])
  contact          Contact? @relation("BankAccounts", fields: [contactId], references: [id])
  financialRecords FinancialRecord[]

  @@index([contactId])
  @@map("bank_accounts")
}


// 3. A "INVENÇÃO DR.X": TRIAGEM E COMUNICAÇÃO
model CommunicationLog {
  id          String   @id @default(uuid())
  tenantId    String
  contactId   String?
  direction   String   // INBOUND, OUTBOUND
  channel     String   // WHATSAPP
  content     String
  mediaUrl    String?  // Caminho local do arquivo
  mediaType   String?  // AUDIO, IMAGE, PDF
  status      String   // RECEIVED, TRIAGED, ARCHIVED
  processedBy String?  // AI or AGENT
  createdAt   DateTime @default(now())

  contact     Contact? @relation(fields: [contactId], references: [id])
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  @@map("communication_logs")
}

// 4. MÓDULO DE MODELOS DE DOCUMENTOS (DR.X MODELS)

model DocumentCategory {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  parentId    String?
  
  parent      DocumentCategory? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    DocumentCategory[] @relation("CategoryHierarchy")
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  templates   DocumentTemplate[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("document_categories")
}

model DocumentTemplate {
  id          String   @id @default(uuid())
  tenantId    String
  title       String
  content     String   @db.Text
  categoryId  String?
  
  category    DocumentCategory? @relation(fields: [categoryId], references: [id])
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  history     DocumentHistory[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("document_templates")
}

model DocumentHistory {
  id          String   @id @default(uuid())
  tenantId    String
  templateId  String?
  title       String
  content     String   @db.Text
  snapshot    Json?    // Stores the variables values at time of creation
  status      String   // DRAFT, FINALIZED
  
  template    DocumentTemplate? @relation(fields: [templateId], references: [id])
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("document_history")
}

model DocumentSettings {
  id          String   @id @default(uuid())
  key         String   @unique // HEADER, FOOTER, FONT_FAMILY
  value       String?
  
  updatedAt   DateTime @updatedAt

  @@map("document_settings")
}
// 5. MÓDULO DE ETIQUETAS (TAGS TRANSVERSAIS)
model Tag {
  id        String   @id @default(uuid())
  tenantId  String
  name      String
  color     String   // Hex code
  textColor String?  // Hex code
  scope     Json?    // ["CONTACT", "PROCESS", "FINANCE", "TASK"]
  usage     Int      @default(0)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  contacts  ContactTag[]

  @@map("tags")
}

model ContactTag {
  id        String   @id @default(uuid())
  tagId     String
  contactId String
  
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  contact   Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([tagId, contactId])
  @@map("tags_on_contacts")
}

// 6. MÓDULO AGENDA (COMPROMISSOS)
model Appointment {
  id          String   @id @default(uuid())
  tenantId    String
  title       String
  description String?
  type        String   // AUDIENCIA, PRAZO, REUNIAO, INTIMACAO
  startAt     DateTime
  endAt       DateTime
  status      String   // SCHEDULED, CONFIRMED, IN_PROGRESS, DONE, CANCELED, RESCHEDULED
  location    String?  // Físico ou Link (Zoom/Meet)
  
  // Vínculos
  processId   String?
  process     Process? @relation(fields: [processId], references: [id])
  
  recurrence  Json?    // Regra de recorrência (RRule)
  
  participants AppointmentParticipant[]
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("appointments")
}

model AppointmentParticipant {
  id            String   @id @default(uuid())
  appointmentId String
  contactId     String?  // Pode ser um contato da base
  name          String?  // Ou apenas um nome avulso
  role          String   // RESPONSABLE, CLIENT, WITNESS, EXPERT
  confirmed     Boolean  @default(false)
  
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  contact       Contact?    @relation(fields: [contactId], references: [id])

  @@map("appointment_participants")
}

// 7. MÓDULO ESTOQUE (PRODUTOS & MOVIMENTAÇÕES)
model Product {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  barcode     String?
  minStock    Int      @default(0)
  currentStock Int     @default(0)
  costPrice   Decimal? @db.Decimal(10, 2)
  sellPrice   Decimal? @db.Decimal(10, 2)
  
  supplierId  String?
  supplier    Supplier? @relation(fields: [supplierId], references: [id])
  
  movements   InventoryMovement[]
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("products")
}

model Supplier {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  document    String?  // CNPJ
  email       String?
  phone       String?
  
  products    Product[]
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  createdAt   DateTime @default(now())

  @@map("suppliers")
}

model InventoryMovement {
  id          String   @id @default(uuid())
  tenantId    String
  productId   String
  type        String   // IN (Entrada), OUT (Saída), ADJUST (Ajuste)
  quantity    Int
  unitPrice   Decimal? @db.Decimal(10, 2)
  totalPrice  Decimal? @db.Decimal(10, 2)
  reason      String?
  
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  createdAt   DateTime @default(now())

  @@map("inventory_movements")
}

// 8. MÓDULO ATENDIMENTO V2 (OMNICHANNEL TICKETS)
model Ticket {
  id          String   @id @default(uuid())
  tenantId    String
  code        Int      @default(autoincrement()) // Protocolo numérico amigável
  title       String
  status      String   // OPEN, IN_PROGRESS, WAITING, RESOLVED, CLOSED
  priority    String   // LOW, MEDIUM, HIGH, URGENT
  channel     String   // WHATSAPP, EMAIL, PHONE, WEBCHAT
  
  contactId   String?
  contact     Contact? @relation(fields: [contactId], references: [id])
  
  assigneeId  String?  // Usuário responsável (User ID)
  queue       String?  // Departamento (FINANCEIRO, JURIDICO)
  
  messages    TicketMessage[]
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("tickets")
}

model TicketMessage {
  id          String   @id @default(uuid())
  ticketId    String
  senderType  String   // USER (Agente), CONTACT (Cliente), SYSTEM (Bot)
  senderId    String?  // ID do User ou Contact
  content     String   @db.Text
  contentType String   // TEXT, IMAGE, AUDIO, FILE
  mediaUrl    String?
  
  readAt      DateTime?
  
  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  @@map("ticket_messages")
}

model WaInstance {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  status      String   // DISCONNECTED, PAIRING, CONNECTED
  qrCode      String?  @db.Text
  serverUrl   String?
  apiKey      String?
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  updatedAt   DateTime @updatedAt

  @@map("wa_instances")
}
