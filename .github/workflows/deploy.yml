name: Deploy Production
on:
  push:
    branches: [ main ]
jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    steps:
      - name: Connect and Update
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            # 1. Carregar Ambiente
            source /etc/profile
            [ -f ~/.bashrc ] && source ~/.bashrc
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            cd /www/wwwroot/DrX
            set -e 

            echo "1. Sincronizando cÃ³digo..."
            git fetch --all
            git reset --hard origin/main

            echo "2. Instalando dependÃªncias..."
            # Usando --no-audit para ser mais rÃ¡pido
            npm install --no-audit

            echo "3. Sincronizando Banco de Dados..."
            # ForÃ§amos a porta 5434 caso o .env esteja errado
            export DATABASE_URL="postgresql://drx:drx_secure_pass_123@localhost:5434/drx_db?schema=public"
            
            npx prisma generate --schema=packages/database/prisma/schema.prisma
            npx prisma db push --schema=packages/database/prisma/schema.prisma --accept-data-loss

            echo "4. Executando Build..."
            # Limpa cache do turbo para evitar lixo de builds antigas
            npx turbo run build --force

            echo "5. Reiniciando serviÃ§os..."
            # API
            pm2 restart drx-api || pm2 start apps/api/dist/main.js --name drx-api

            # Web App
            pm2 delete drx-web || true
            pm2 serve apps/web/dist 8080 --name drx-web --spa

            # Studio
            pm2 delete drx-studio || true
            pm2 start "npx prisma studio --port 5555 --schema=packages/database/prisma/schema.prisma" --name drx-studio

            pm2 save
            echo "ðŸš€ DR.X ONLINE NA PORTA 5434!"
            pm2 status
