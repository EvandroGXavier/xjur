name: Deploy Production

on: [push]

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    steps:
      - name: Connect and Update
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script_stop_on_error: true
          script: |
            # Carregar variáveis de ambiente do aaPanel/Linux
            source /etc/profile
            [ -f ~/.bashrc ] && source ~/.bashrc
            
            # Garantir NVM se existir
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            # Debug: Mostrar versões para garantir que estamos usando o Node certo
            echo "Node version: $(node -v)"
            echo "NPM version: $(npm -v)"
            echo "PM2 path: $(which pm2)"

            cd /www/wwwroot/DrX || exit 1
            
            echo "1. Sincronizando código com GitHub..."
            # Reset hard para garantir estado limpo
            git fetch origin main || exit 1
            git reset --hard origin/main || exit 1
            
            echo "2. Limpando dependencias e builds antigos..."
            # Removemos node_modules para garantir que não haja conflitos de versão
            rm -rf node_modules
            rm -rf apps/api/node_modules
            rm -rf apps/web/node_modules
            rm -rf packages/database/node_modules
            rm -rf apps/web/dist apps/api/dist
            
            echo "3. Instalando dependências (Clean Install)..."
            # Instala todas as dependências do monorepo
            npm install || exit 1
            
            echo "4. Gerando Prisma Client..."
            # Força a geração do cliente do banco
            npx turbo run db:generate || exit 1
            
            echo "5. Atualizando Banco de Dados (Force)..."
            # --accept-data-loss: Aceita perda de dados se houver alteração de esquema destrutiva (conforme solicitado)
            # Executamos direto o prisma para garantir que o flag seja passado corretamente
            npx prisma db push --schema=packages/database/prisma/schema.prisma --accept-data-loss || exit 1
            
            echo "6. Executando Build (API + Web)..."
            # --force ignora cache do turbo para garantir rebuild completo
            npx turbo run build --force || exit 1
            
            echo "7. Reiniciando ecossistema PM2..."
            # Reinicia processos para carregar código novo da API
            pm2 delete all || true
            pm2 start ecosystem.config.js --update-env || exit 1
            pm2 save || exit 1
            
            echo "✅ DEPLOY DO DR.X CONCLUÍDO COM SUCESSO!"
            pm2 status