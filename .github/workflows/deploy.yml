name: Deploy Production
on:
  push:
    branches: [ main ]
jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    steps:
      - name: Connect and Update
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            # 1. Carregar Ambiente
            source /etc/profile
            [ -f ~/.bashrc ] && source ~/.bashrc
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            cd /www/wwwroot/DrX
            set -e 

            echo "========================================="
            echo "ğŸš€ DR.X DEPLOY - $(date)"
            echo "========================================="

            echo "1ï¸âƒ£ Sincronizando cÃ³digo..."
            git fetch --all
            git reset --hard origin/main
            echo "âœ… CÃ³digo sincronizado: $(git log --oneline -1)"

            echo "2ï¸âƒ£ Instalando dependÃªncias..."
            npm install --no-audit --prefer-offline
            echo "âœ… DependÃªncias instaladas"

            echo "3ï¸âƒ£ Sincronizando Banco de Dados..."
            export DATABASE_URL="postgresql://drx:drx_secure_pass_123@localhost:5434/drx_db?schema=public"
            
            npx prisma generate --schema=packages/database/prisma/schema.prisma
            npx prisma db push --schema=packages/database/prisma/schema.prisma --accept-data-loss
            echo "âœ… Banco sincronizado"

            echo "4ï¸âƒ£ Executando Build..."
            npx turbo run build --force
            echo "âœ… Build concluÃ­do"

            # Verificar se os builds existem
            echo "ğŸ“ Verificando arquivos de build..."
            ls -la apps/api/dist/main.js 2>/dev/null && echo "âœ… API build OK" || echo "âŒ API build FALTANDO!"
            ls -la apps/web/dist/index.html 2>/dev/null && echo "âœ… Web build OK" || echo "âŒ Web build FALTANDO!"

            echo "5ï¸âƒ£ Reiniciando serviÃ§os..."

            # Parar tudo antes de reiniciar
            pm2 delete drx-api 2>/dev/null || true
            pm2 delete drx-web 2>/dev/null || true
            pm2 delete drx-studio 2>/dev/null || true

            # API - com variÃ¡veis de ambiente
            cd /www/wwwroot/DrX
            DATABASE_URL="postgresql://drx:drx_secure_pass_123@localhost:5434/drx_db?schema=public" \
            pm2 start apps/api/dist/main.js --name drx-api --update-env

            # Esperar API inicializar
            sleep 3

            # Verificar se API estÃ¡ rodando
            if pm2 show drx-api | grep -q "online"; then
              echo "âœ… API online"
            else
              echo "âŒ API falhou! Logs:"
              pm2 logs drx-api --lines 30 --nostream
            fi

            # Web App
            pm2 serve apps/web/dist 8080 --name drx-web --spa
            echo "âœ… Web servindo na porta 8080"

            # Studio
            pm2 start "npx prisma studio --port 5555 --schema=/www/wwwroot/DrX/packages/database/prisma/schema.prisma" --name drx-studio
            echo "âœ… Studio na porta 5555"

            pm2 save

            echo "========================================="
            echo "ğŸ“Š STATUS FINAL:"
            echo "========================================="
            pm2 status

            # Health check
            echo ""
            echo "ğŸ©º HEALTH CHECK:"
            sleep 2
            curl -s -o /dev/null -w "API (3000): HTTP %{http_code}\n" http://localhost:3000/api/health 2>/dev/null || echo "API (3000): âŒ Sem resposta"
            curl -s -o /dev/null -w "Web (8080): HTTP %{http_code}\n" http://localhost:8080/ 2>/dev/null || echo "Web (8080): âŒ Sem resposta"
            echo ""
            echo "ğŸš€ DR.X DEPLOY COMPLETO!"