name: Deploy Production
on:
  push:
    branches: [ main ]
jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    steps:
      - name: Connect and Update
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            # 1. Carregar Ambiente
            source /etc/profile
            [ -f ~/.bashrc ] && source ~/.bashrc
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            cd /www/wwwroot/DrX
            set -e 

            echo "========================================="
            echo "๐ DR.X DEPLOY (Docker) - $(date)"
            echo "========================================="

            echo "1๏ธโฃ Sincronizando cรณdigo..."
            git fetch --all
            git reset --hard origin/main
            echo "โ Cรณdigo sincronizado: $(git log --oneline -1)"

            echo "2๏ธโฃ Limpando PM2 legado..."
            pm2 delete drx-api 2>/dev/null || true
            pm2 delete drx-web 2>/dev/null || true
            pm2 delete drx-studio 2>/dev/null || true
            pm2 save 2>/dev/null || true

            echo "3๏ธโฃ Configurando variรกveis de ambiente..."
            export JWT_SECRET="${{ secrets.JWT_SECRET }}"
            export POSTGRES_USER="drx"
            export POSTGRES_PASSWORD="drx_secure_pass_123"
            export POSTGRES_DB="drx_db"
            export APP_URL="https://drx.evandroadvogado.com"
            export EVOLUTION_API_KEY="${{ secrets.EVOLUTION_API_KEY }}"
            export EVOLUTION_SERVER_URL="https://evolution.evandroadvogado.com"
            
            echo "4๏ธโฃ Reconstruindo containers (API + Web)..."
            docker compose -f docker-compose.prod.yml build --no-cache api web
            
            echo "5๏ธโฃ Reiniciando stack completa..."
            docker compose -f docker-compose.prod.yml up -d
            
            echo "6๏ธโฃ Sincronizando banco de dados..."
            sleep 8
            docker exec drx_api_prod npx prisma db push --schema=packages/database/prisma/schema.prisma --accept-data-loss 2>/dev/null || echo "โ๏ธ Prisma push falhou (pode jรก estar sincronizado)"
            
            echo "========================================="
            echo "๐ STATUS FINAL:"
            echo "========================================="
            docker compose -f docker-compose.prod.yml ps

            # Health check
            echo ""
            echo "๐ฉบ HEALTH CHECK:"
            sleep 5
            curl -s -o /dev/null -w "API  (3000): HTTP %{http_code}\n" http://localhost:3000/api 2>/dev/null || echo "API  (3000): โ Sem resposta"
            curl -s -o /dev/null -w "Web  (8080): HTTP %{http_code}\n" http://localhost:8080/ 2>/dev/null || echo "Web  (8080): โ Sem resposta"
            curl -s -o /dev/null -w "Evol (8081): HTTP %{http_code}\n" http://localhost:8081/ 2>/dev/null || echo "Evol (8081): โ Sem resposta"
            echo ""
            echo "๐ DR.X DEPLOY COMPLETO!"