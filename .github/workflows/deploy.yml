name: Deploy Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    steps:
      - name: Connect and Update
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            # Carregar ambiente para garantir que comandos como npm e pm2 funcionem
            source /etc/profile
            [ -f ~/.bashrc ] && source ~/.bashrc
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

            cd /www/wwwroot/DrX
            set -e # Aborta se qualquer comando falhar
            
            echo "1. Sincronizando código com GitHub..."
            git fetch --all
            git reset --hard origin/main
            
            echo "2. Instalando dependências..."
            npm install
            
            echo "3. Sincronizando Banco de Dados..."
            # Gera o client e aplica mudanças de schema de forma segura
            npx turbo run db:generate
            npx prisma db push --schema=packages/database/prisma/schema.prisma --accept-data-loss
            
            echo "4. Executando Build (Turbo)..."
            # Builda todo o monorepo respeitando as dependências internas
            npx turbo run build
            
            echo "5. Reiniciando serviços do DR.X..."
            
            # API (NestJS)
            pm2 restart drx-api || pm2 start apps/api/dist/main.js --name drx-api
            
            # Web App (Vite - Servido via PM2)
            # Rodando na porta 8080 conforme sua solicitação
            pm2 delete drx-web || true
            pm2 serve apps/web/dist 8080 --name drx-web --spa
            
            # Prisma Studio (Acesso administrativo na porta 5555)
            pm2 delete drx-studio || true
            pm2 start "npx prisma studio --port 5555 --schema=packages/database/prisma/schema.prisma" --name drx-studio
            
            pm2 save
            echo "🚀 Sistema DR.X atualizado com sucesso!"
            pm2 status