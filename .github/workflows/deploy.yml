name: Deploy Production
on:
  push:
    branches: [ main ]
jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    steps:
      - name: Connect and Update
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: root
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            # 1. Preparar Ambiente
            source /etc/profile
            [ -f ~/.bashrc ] && source ~/.bashrc
            
            cd /www/wwwroot/DrX
            set -e 

            echo "========================================="
            echo "üöÄ DR.X SUPREMO DEPLOY - $(date)"
            echo "========================================="

            echo "1Ô∏è‚É£ Sincronizando c√≥digo do GitHub..."
            git fetch --all
            git reset --hard origin/main
            echo "‚úÖ C√≥digo: $(git log --oneline -1)"

            echo "2Ô∏è‚É£ Limpando processos legados PM2..."
            pm2 delete all 2>/dev/null || true
            pm2 save --force 2>/dev/null || true

            echo "3Ô∏è‚É£ Configurando Vari√°veis PRD 2026..."
            # Definindo a URL de conex√£o do banco conforme o PRD
            export DATABASE_URL="postgresql://drx:drx_secure_pass_123@db:5432/drx_db?schema=public"
            export APP_URL="https://dr-x.xtd.com.br"
            export API_URL="https://api.dr-x.xtd.com.br"
            export JWT_SECRET="${{ secrets.JWT_SECRET }}"
            
            echo "4Ô∏è‚É£ Reconstruindo Containers (API + Web)..."
            # Usando --build-arg se necess√°rio ou garantindo o .env interno
            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml build --no-cache api web
            
            echo "5Ô∏è‚É£ Subindo a Stack DR.X..."
            docker compose -f docker-compose.prod.yml up -d
            
            echo "6Ô∏è‚É£ Sincronizando Schema do Banco (Prisma)..."
            sleep 10
            # Rodando o push atrav√©s do container da API
            docker exec drx_api_prod npx prisma db push --accept-data-loss
            
            echo "========================================="
            echo "üìä STATUS DOS SERVI√áOS:"
            echo "========================================="
            docker compose -f docker-compose.prod.yml ps

            echo ""
            echo "ü©∫ HEALTH CHECK (Dom√≠nios 2026):"
            sleep 5
            curl -I https://dr-x.xtd.com.br | grep "HTTP" || echo "Web: ‚ùå Offline"
            curl -I https://api.dr-x.xtd.com.br/health | grep "HTTP" || echo "API: ‚ùå Offline"
            
            echo "üöÄ DEPLOY FINALIZADO COM SUCESSO!"