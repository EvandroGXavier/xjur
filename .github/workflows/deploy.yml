name: Deploy Production
on:
  push:
    branches: [ main ]
jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    steps:
      - name: Connect and Update
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: root
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            source /etc/profile
            [ -f ~/.bashrc ] && source ~/.bashrc
            
            cd /www/wwwroot/DrX
            set -e 

            echo "========================================="
            echo "üöÄ DR.X SUPREMO DEPLOY (V2 CORRIGIDA) - $(date)"
            echo "========================================="

            echo "1Ô∏è‚É£ Sincronizando c√≥digo..."
            git fetch --all
            git reset --hard origin/main

            echo "2Ô∏è‚É£ Limpando PM2..."
            pm2 delete all 2>/dev/null || true

            echo "3Ô∏è‚É£ Configurando Vari√°veis..."
            export DATABASE_URL="postgresql://drx:drx_secure_pass_123@db:5432/drx_db?schema=public"
            
            echo "4Ô∏è‚É£ Reconstruindo Containers..."
            docker compose -f docker-compose.prod.yml build --no-cache api web
            
            echo "5Ô∏è‚É£ Subindo a Stack..."
            docker compose -f docker-compose.prod.yml up -d
            
            echo "6Ô∏è‚É£ Sincronizando Banco de Dados (Caminho Monorepo)..."
            sleep 12
            # Corre√ß√£o aqui: apontando o caminho exato do schema no monorepo
            docker exec drx_api_prod npx prisma db push --schema=packages/database/prisma/schema.prisma --accept-data-loss
            
            echo "========================================="
            echo "üìä STATUS FINAL:"
            echo "========================================="
            docker compose -f docker-compose.prod.yml ps

            echo ""
            echo "ü©∫ HEALTH CHECK:"
            sleep 5
            curl -I https://dr-x.xtd.com.br | grep "HTTP" || echo "Web: ‚ùå Offline"
            curl -I https://api.dr-x.xtd.com.br/app | grep "HTTP" || echo "API: ‚ùå Offline"
            
            echo "üöÄ DEPLOY FINALIZADO COM SUCESSO!"